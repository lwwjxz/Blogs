0. 什么是单链路和全链路？    
    1. 单链路：用户的一次点击就是一条牙齿链路，比如查询商品详情页、支付、查看订单列表等等。它涵盖了从前端http，到统一网关、nginx、后端hsf服务、缓存、DB整个过程。    
    2. 全链路：所有单链路的集合，一般是关键链路，比如商品详情页、搜索功能、支付功能。相当于大促(期末考试)前的模拟考试。全链路一起压测就是全链路压测。             
1. 为什么要进行全链路压测？   
  如果不进行全链路压测，只是对各个系统分别进行压测只能保证各个系统单独运行时候的稳定性，不能保证整个集群稳定性。就像大量零件组成的机器一样单个每个零件都合格是不能保证机器的正常运转的。
  对于存在突发大流量场景的业务，准确评估系统的实际承载能力非常困难。进行全链路压测是非常有必要的(不一定是全公司的，可以是某个子域的全链路压测)   
2. 适用场景    
    1. 活动场景、突发大流量场景比如双十一前。
    2. 新业务上线，如果新业务一上线即会有比较大的用户流量，通过全链路压测确保新上线的业务不会一上线就挂掉。
4. 如何选择压测方案？    
  最容易想到的全链路压测方案就是模拟真实的数据和生产环境进行压测，但是真实数据不好模拟，完全复制一套生产环境作为压测环境成本(包括机器成本和人力成本)太高，不太现实。所以大部分公司包括阿里，有赞，京东选择的压测方案是在生产环境直接进行压测，这样一来就不用部署一套昂贵的生产环境了。但是压测的写数据动作会产生脏数据，避免产生脏数据的方案就是给压测数据打标把数据写到影子库、消息队列，缓存等。压测时间要选择系统的低峰期尽量降低压测对线上业务的影响。      
5. 压测的核心要素     
    1. 压测对象: 被压测的系统。     
    2. 压测数据: 
         1. 压测基础数据比如卖家，买家，商品，优惠等的规模要与实际业务场景一致       
         2. 压测链路数据比如详情页，购物车访问，提交订单，订单列表。 链路数据包括一个压测请求和多样化的参数，比如支付请求包括信用卡支付、花呗支付、银行卡支付、余额不够的场景、不支持信用卡支付的场景，各种场景都要考虑到     
         3. 压测模型，比如要不要模拟热点卖家，热点商品等。       
    3. 压测流量: 
         1. 需要流量安装指定好的协议，指定的速率，从全国各地发送。    
         2. 压测试保证登录态不会失效。    
6. 压测对象改造，原则1. 压测流量在任何环节都要能识别。2. 压测流程不会被阻断。 3. 压测数据不污染线上数据
    1. rpc：要支持压测标透传，多线程需要业务系统手动透传。   
    2. 消息：provider和consumer要识别压测标。   
    3. 缓存：压测流量缓存不能污染正常缓存，一般的解决方案是在缓存key前加固定的前缀，比如“jingdong_test”    
    4. 存储：压测数据不对正常的数据造成污染。影子表。  
    5. 日志：压测的日志要能跟正常的日志区分开。有区分标志位，或者存储在不同地方。    
    6. 安全拦截：如果压测流量被安全系统拦截需要有放行。    
    7. 各个中间件要强检验，比如数据库连接中间件不能让压测流量写入正式表。      
7. 压测的数据构建规范。压测数据分为基础业务数据和链路数据。比如，比如用户购物车下单场景，会涉及到“用户基本信息”，“用户的购物车商品信息”，“商品详情”，“商品库存”，“优惠数据”等基础数据。根据压测的模型构建出请求url和参数，构成链路数据。
    1. 梳理整个链路可能会覆盖到的数据库，并对所有数据集库简历影子表。包括基础业务数据的表和压测中可能存在的写操作的表。
    2. 影子表同正式表要有相同的表结构和索引。尽量在同一个数据库实例中。    
    3. 要对迁移到数据库中的影子表进行脱敏。   
    4. 基础数据迁移的过程中，需要对基础数据做必要的表示（比如对id做偏移）。保证能识别出压测数据和真实数据。    
8. 全链路压测的接入过程SOP。     
    1. 架构梳理：理清整个架构的分层结构，模块划分，以及RPC，消息，缓存，数据库驱动等中间件的使用情况。     
    2. 业务梳理：梳理业务链路，各个模块的调用关系。     
    3. 中间件升级： 解决RPC，消息，缓存，数据库驱动，压测标透传等等问题。 
    4. 系统改造：解决压测标不能透传（比如多线程）
    5. 建影子表
    6. 测试，整个链路是否符合预期，比如没有污染正式数据，缓存等。

9. 压测系统架构图
<img width="632" alt="image" src="https://user-images.githubusercontent.com/12959356/193414455-8718f9d7-13b0-40d2-b0af-55450e90ba42.png">

10. 压测步骤
    1. 压测方案配置
    2. 预跑: 正式压测前1~2天，按照模型的小比例压测。    
    3. 预热: 预热的目的是将当前系统中的缓存，tair，DB缓存等预热到大促态。同时为防止核心应用在流量脉冲进来时代码还没有编译。需要提前进行jit预热，预热的最终效果是让应用的各级缓存热起来，在大促脉冲的瞬间缓存能稳定运行。   
    4. 正式
    3. 预热: 预热的目的是将当前系统中的缓存，tair，DB缓存等预热到大促态。同时为防止核心应用在流量脉冲进来时代码还没有编译。需要提前进行jit预热，预热的最终效果是让应用的各级缓存热起来，在大促脉冲的瞬间缓存能稳定运行。   
    3. 预热: 预热的目的是将当前系统中的缓存，tair，DB缓存等预热到大促态。同时为防止核心应用在流量脉冲进来时代码还没有编译。需要提前进行jit预热，预热的最终效果是让应用的各级缓存热起来，在大促脉冲的瞬间缓存能稳定运行。     
    4. 正式压测
        1. 0点脉冲，完全模拟大促峰值流量。观察各个系统表现。
        2. 摸高：放开限流，将压力抬高到目标峰值的10%，观察系统的极限值，如果在这个范围内还稳定，可以继续网上加压，一直到有系统扛不住为至。
        3. 限流验证：在摸高达到最高状态后，生效限流，查看限流是否正确。
        4. 破坏性测试：各业务系统执行紧急元，观察这些预案对系统的影响（比如停止打印日志等）。   
        5. 复盘。
        6. 3、4不能在生产系统测试。如果能保证不影响正常的业务也可以在生产系统测试。    



